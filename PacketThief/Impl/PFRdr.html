<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class PacketThief::Impl::PFRdr - TLSPretense </title>

<link type="text/css" media="screen" href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="../../index.html">Home</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/packetthief/impl/pf_rdr.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link">Object
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-original_dest">::original_dest</a>
    
    <li><a href="#method-c-redirect">::redirect</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="../../README_rdoc.html">README</a>
  
    <li class="file"><a href="../../doc/general_setup_rdoc.html">general_setup</a>
  
    <li class="file"><a href="../../doc/linux_setup_rdoc.html">linux_setup</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="../../PacketThief.html">PacketThief</a>
  
    <li><a href="../../PacketThief/Handlers.html">PacketThief::Handlers</a>
  
    <li><a href="../../PacketThief/Handlers/AbstractSSLHandler.html">PacketThief::Handlers::AbstractSSLHandler</a>
  
    <li><a href="../../PacketThief/Handlers/ProxyRedirector.html">PacketThief::Handlers::ProxyRedirector</a>
  
    <li><a href="../../PacketThief/Handlers/SSLClient.html">PacketThief::Handlers::SSLClient</a>
  
    <li><a href="../../PacketThief/Handlers/SSLServer.html">PacketThief::Handlers::SSLServer</a>
  
    <li><a href="../../PacketThief/Handlers/SSLServer/InitialServer.html">PacketThief::Handlers::SSLServer::InitialServer</a>
  
    <li><a href="../../PacketThief/Handlers/SSLSmartProxy.html">PacketThief::Handlers::SSLSmartProxy</a>
  
    <li><a href="../../PacketThief/Handlers/SSLTransparentProxy.html">PacketThief::Handlers::SSLTransparentProxy</a>
  
    <li><a href="../../PacketThief/Handlers/SSLTransparentProxy/SSLProxyConnection.html">PacketThief::Handlers::SSLTransparentProxy::SSLProxyConnection</a>
  
    <li><a href="../../PacketThief/Handlers/TransparentProxy.html">PacketThief::Handlers::TransparentProxy</a>
  
    <li><a href="../../PacketThief/Handlers/TransparentProxy/ProxyConnection.html">PacketThief::Handlers::TransparentProxy::ProxyConnection</a>
  
    <li><a href="../../PacketThief/Impl.html">PacketThief::Impl</a>
  
    <li><a href="../../PacketThief/Impl/Ipfw.html">PacketThief::Impl::Ipfw</a>
  
    <li><a href="../../PacketThief/Impl/Ipfw/IpfwRule.html">PacketThief::Impl::Ipfw::IpfwRule</a>
  
    <li><a href="../../PacketThief/Impl/Ipfw/IpfwRuleHandler.html">PacketThief::Impl::Ipfw::IpfwRuleHandler</a>
  
    <li><a href="../../PacketThief/Impl/Manual.html">PacketThief::Impl::Manual</a>
  
    <li><a href="../../PacketThief/Impl/Manual/NullRule.html">PacketThief::Impl::Manual::NullRule</a>
  
    <li><a href="../../PacketThief/Impl/Manual/NullRuleHandler.html">PacketThief::Impl::Manual::NullRuleHandler</a>
  
    <li><a href="../../PacketThief/Impl/Netfilter.html">PacketThief::Impl::Netfilter</a>
  
    <li><a href="../../PacketThief/Impl/Netfilter/IPTablesRule.html">PacketThief::Impl::Netfilter::IPTablesRule</a>
  
    <li><a href="../../PacketThief/Impl/Netfilter/IPTablesRuleHandler.html">PacketThief::Impl::Netfilter::IPTablesRuleHandler</a>
  
    <li><a href="../../PacketThief/Impl/PFDivert.html">PacketThief::Impl::PFDivert</a>
  
    <li><a href="../../PacketThief/Impl/PFDivert/PFDivertRule.html">PacketThief::Impl::PFDivert::PFDivertRule</a>
  
    <li><a href="../../PacketThief/Impl/PFDivert/PFDivertRuleHandler.html">PacketThief::Impl::PFDivert::PFDivertRuleHandler</a>
  
    <li><a href="../../PacketThief/Impl/PFRdr.html">PacketThief::Impl::PFRdr</a>
  
    <li><a href="../../PacketThief/Impl/PFRdr/PFRdrRule.html">PacketThief::Impl::PFRdr::PFRdrRule</a>
  
    <li><a href="../../PacketThief/Impl/PFRdr/PFRdrRuleHandler.html">PacketThief::Impl::PFRdr::PFRdrRuleHandler</a>
  
    <li><a href="../../PacketThief/Logging.html">PacketThief::Logging</a>
  
    <li><a href="../../PacketThief/RedirectRule.html">PacketThief::RedirectRule</a>
  
    <li><a href="../../PacketThief/Util.html">PacketThief::Util</a>
  
    <li><a href="../../SSLTest.html">SSLTest</a>
  
    <li><a href="../../SSLTest/AppContext.html">SSLTest::AppContext</a>
  
    <li><a href="../../SSLTest/CertificateManager.html">SSLTest::CertificateManager</a>
  
    <li><a href="../../SSLTest/Config.html">SSLTest::Config</a>
  
    <li><a href="../../SSLTest/InputHandler.html">SSLTest::InputHandler</a>
  
    <li><a href="../../SSLTest/Runner.html">SSLTest::Runner</a>
  
    <li><a href="../../SSLTest/SSLTestCase.html">SSLTest::SSLTestCase</a>
  
    <li><a href="../../SSLTest/SSLTestReport.html">SSLTest::SSLTestReport</a>
  
    <li><a href="../../SSLTest/SSLTestResult.html">SSLTest::SSLTestResult</a>
  
    <li><a href="../../SSLTest/TestListener.html">SSLTest::TestListener</a>
  
    <li><a href="../../CertMaker.html">CertMaker</a>
  
    <li><a href="../../CertMaker/CertificateFactory.html">CertMaker::CertificateFactory</a>
  
    <li><a href="../../CertMaker/CertificateSuiteGenerator.html">CertMaker::CertificateSuiteGenerator</a>
  
    <li><a href="../../Hash.html">Hash</a>
  
    <li><a href="../../IO.html">IO</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class PacketThief::Impl::PFRdr</h1>

  <div id="description" class="description">
    
<p>Implementation that uses PF’s <code>rdr</code> (old style rules) and parses
pfctl’s output to interoperate with Mac OS X 10.7 Lion.</p>

<p>It assumes that the system running <a
href="../../PacketThief.html">PacketThief</a> is already set up to reroute
traffic like a NAT (On Mac OS X, you can do this by enabling Internet
Sharing).</p>

<p>To use it, you need to add the following rule to your /etc/pf.conf file in
the “Translation” section.</p>

<pre>rdr-anchor &quot;packetthief&quot;</pre>

<p>This rule probably should be inserted after any NAT rules, but before any
other redirect rules (such as Apple’s <code>rdr-anchor</code> rule). Once
you have added it, you can reload the core ruleset:</p>

<pre>pfctl -f /etc/pf.conf</pre>

<h2 id="label-Design">Design</h2>

<p>Lion (and Mountain Lion) provide an older implementation of PF (circa
OpenBSD 4.3 and earlier) that does not contain the <code>divert-to</code>
action. Furthermore, Apple has decided to not make pfvars.h a public header
file, making it marginally difficult to compile C code that can look up the
original destination. Instead, we use pfctl to look up the state table, and
we parse its output to find the current connection and acquire its original
destination.</p>

<p>Redirect rules look like the following:</p>

<pre>rdr on en1 proto tcp from any to any port 443 -&gt; 127.0.0.1 port 54321</pre>

<p>The pfctl state table output looks something like:</p>

<pre>   $ sudo pfctl -s states
   No ALTQ support in kernel
   ALTQ related functions disabled
   ALL tcp 74.125.224.68:80 &lt;- 192.168.2.2:52995       ESTABLISHED:ESTABLISHED
   ALL tcp 192.168.2.2:52995 -&gt; 10.0.1.2:33596 -&gt; 74.125.224.68:80       ESTABLISHED:ESTABLISHED
   ALL tcp 127.0.0.1:54321 &lt;- 173.194.79.147:443 &lt;- 192.168.2.2:52998       CLOSED:SYN_SENT
   ALL tcp 127.0.0.1:54321 &lt;- 173.194.79.147:443 &lt;- 192.168.2.2:52999       CLOSED:SYN_SENT
   ALL tcp 127.0.0.1:54321 &lt;- 173.194.79.147:443 &lt;- 192.168.2.2:53000       CLOSED:SYN_SENT
   ALL tcp 127.0.0.1:54321 &lt;- 173.194.79.147:443 &lt;- 192.168.2.2:53001       CLOSED:SYN_SENT
   ALL udp 192.168.2.1:53 &lt;- 192.168.2.2:53690       SINGLE:MULTIPLE
   ALL tcp 74.125.224.105:80 &lt;- 192.168.2.2:53002       ESTABLISHED:ESTABLISHED
   ALL tcp 192.168.2.2:53002 -&gt; 10.0.1.2:38466 -&gt; 74.125.224.105:80       ESTABLISHED:ESTABLISHED
   ALL udp 224.0.0.251:5353 &lt;- 10.0.1.4:5353       NO_TRAFFIC:SINGLE
   ALL udp ff02::fb[5353] &lt;- fe80::72de:e2ff:fe41:5ddd[5353]       NO_TRAFFIC:SINGLE

/^(?&lt;iface&gt;\S+)\s+(?&lt;proto&gt;\S+)\s+(?&lt;dest&gt;\S+)\s+&lt;-\s+(?&lt;origdest&gt;\S+)\s+&lt;-\s+(?&lt;src&gt;\S+)\s+(?&lt;status&gt;\S+)$/</pre>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="RDR_PAT">RDR_PAT
        
        <dd class="description">
        
      
      </dl>
    </section>
    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-original_dest" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">original_dest</span><span
            class="method-args">(sock)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns the [port, host] for the original destination of <code>sock</code>.</p>

<p><code>Sock</code> can be a Ruby socket or an EventMachine::Connection
(including handler modules, which are mixed in to an anonymous descendent
of EM::Connection).</p>

<p>When PF uses a nat/rdr rule, it stores the original destination in a table
that can be queried using an ioctl() call on the /dev/pf device.
Unfortunately for Mac OS X 10.7 and 10.8, Apple does not provide the
necessary pfvars.h header for querying pf, although it exists in the XNU
kernel source, which marks it as a “private” header. Apple’s version is
also “different” from the version supported by most BSDs these days,
creating additional headaches.</p>

<p>To work around this, we instead use +pfctl -s states+ to get the nat state
information.</p>
          

          
          <div class="method-source-code" id="original_dest-source">
            <pre><span class="ruby-comment"># File lib/packetthief/impl/pf_rdr.rb, line 160</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">original_dest</span>(<span class="ruby-identifier">sock</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">sock</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:getsockname</span>
    <span class="ruby-identifier">sockname</span> = <span class="ruby-identifier">sock</span>.<span class="ruby-identifier">getsockname</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">sock</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:get_sockname</span>
    <span class="ruby-identifier">sockname</span> = <span class="ruby-identifier">sock</span>.<span class="ruby-identifier">get_sockname</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;#{sock.inspect} supports neither :getsockname nor :get_sockname!&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">sock</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:getpeername</span>
    <span class="ruby-identifier">peername</span> = <span class="ruby-identifier">sock</span>.<span class="ruby-identifier">getpeername</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">sock</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:get_peername</span>
    <span class="ruby-identifier">peername</span> = <span class="ruby-identifier">sock</span>.<span class="ruby-identifier">get_peername</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;#{sock.inspect} supports neither :getpeername nor :get_peername!&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">dest</span> = <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">unpack_sockaddr_in</span>(<span class="ruby-identifier">sockname</span>)
  <span class="ruby-identifier">src</span> = <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">unpack_sockaddr_in</span>(<span class="ruby-identifier">peername</span>)

  <span class="ruby-identifier">state_table</span> = <span class="ruby-value">%xpfctl -q -s state`</span>
  <span class="ruby-identifier">rdr_lines</span> = <span class="ruby-identifier">state_table</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;\n&quot;</span>).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">match</span>(<span class="ruby-constant">RDR_PAT</span>) }.<span class="ruby-identifier">compact</span>
  <span class="ruby-identifier">matched_conns</span> = <span class="ruby-identifier">rdr_lines</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-identifier">l</span>[<span class="ruby-value">:dest</span>] <span class="ruby-operator">==</span> <span class="ruby-node">&quot;#{dest[1]}:#{dest[0]}&quot;</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">l</span>[<span class="ruby-value">:src</span>] <span class="ruby-operator">==</span> <span class="ruby-node">&quot;#{src[1]}:#{src[0]}&quot;</span> }
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;multiple conns matched: #{matched_conns.inspect}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">matched_conns</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">host</span>, <span class="ruby-identifier">port</span> = <span class="ruby-identifier">matched_conns</span>[<span class="ruby-value">0</span>][<span class="ruby-value">:origdest</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">':'</span>, <span class="ruby-value">2</span>)
  <span class="ruby-identifier">port</span> = <span class="ruby-identifier">port</span>.<span class="ruby-identifier">to_i</span>

  <span class="ruby-identifier">logdebug</span> <span class="ruby-string">&quot;original_dest:&quot;</span>, <span class="ruby-value">:port</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">port</span>, <span class="ruby-value">:host</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">host</span>
  [<span class="ruby-identifier">port</span>, <span class="ruby-identifier">host</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- original_dest-source -->
          
        </div>

        

        
      </div><!-- original_dest-method -->

    
      <div id="method-c-redirect" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">redirect</span><span
            class="method-args">(args={})</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="redirect-source">
            <pre><span class="ruby-comment"># File lib/packetthief/impl/pf_rdr.rb, line 137</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">redirect</span>(<span class="ruby-identifier">args</span>={})
  <span class="ruby-identifier">rule</span> = <span class="ruby-constant">PFRdrRule</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword">self</span>)
  <span class="ruby-identifier">rule</span>.<span class="ruby-identifier">redirect</span>(<span class="ruby-identifier">args</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- redirect-source -->
          
        </div>

        

        
      </div><!-- redirect-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

